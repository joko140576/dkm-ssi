
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal Masjid — One Page</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800&display=swap" rel="stylesheet">

  <style>
:root{
    /* Warna utama Dark Mode */
    --bg-1: #0b1623;        /* biru gelap */
    --bg-2: #112030;        /* biru navy */
    --card: rgba(20, 34, 50, 0.78); /* dark glass */

    --blue-1: #4da3ff;
    --blue-2: #1f6fc7;
    --gold: #e8c15a;        /* emas */
    --gold-soft: #c9a64b;
    --muted: #c5d3e3;

    --glass: rgba(255,255,255,0.08);
  }

  html,body{
    height:100%;
    margin:0;
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    color:var(--muted);
    background:linear-gradient(180deg,var(--bg-1), var(--bg-2));
    background-attachment:fixed;
  }

  /* BACKGROUND ORNAMEN */
  .wrap{
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:10px;
    background-image:
      radial-gradient(circle at 25% 20%, rgba(77,163,255,0.18), transparent 40%),
      radial-gradient(circle at 90% 80%, rgba(32,98,180,0.14), transparent 45%);
  }

  /* CARD */
  .card-main{
    width:1600px;
    max-width:98vw;
    padding:26px;
    border-radius:22px;

    background:var(--card);
    backdrop-filter:blur(12px) saturate(150%);
    border:1px solid rgba(255,255,255,0.05);

    box-shadow:
      0 20px 50px rgba(0,0,0,0.55),
      0 4px 12px rgba(0,0,0,0.3);
  }

  /* HEADER */
  .header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:10px;
    padding-bottom:12px;
    border-bottom:2px solid rgba(232,193,90,0.35);
  }

  .brand h1{
    margin:0;
    font-size:28px;
    font-weight:800;
    color:var(--gold);
  }
  .brand p{
    margin:0;
    font-size:14px;
    opacity:0.85;
    color:var(--muted);
  }

  /* BLOK JADWAL SHOLAT */
  .top-row{
    display:flex;
    gap:20px;
  }

  .pray{
    flex:1;
    padding:18px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.08);

    background:linear-gradient(180deg, rgba(50,70,105,0.25), rgba(20,35,55,0.4));
    backdrop-filter:blur(6px);
  }

  .pray h2{
    margin:0;
    color:var(--gold);
    font-size:22px;
    font-weight:700;
  }

  /* CLOCK */
  .clock-card{
    width:280px;
    padding:18px;
    border-radius:16px;

    background:var(--glass);
    backdrop-filter:blur(10px);
    border:1px solid rgba(255,255,255,0.07);
    text-align:center;
  }

  .clock-now{
    font-size:40px;
    font-weight:800;
    color:var(--gold);
  }
  .hijri-now{
    margin-top:6px;
    color:var(--muted);
    font-size:13px;
  }

  /* BOX WAKTU SHOLAT */
  .times{
    display:flex;
    gap:14px;
    flex-wrap:wrap;
  }
  .pbox{
    padding:14px 16px;
    min-width:150px;
    border-radius:12px;

    background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
    border:1px solid rgba(255,255,255,0.08);

    box-shadow:0 3px 10px rgba(0,0,0,0.45);
  }
  .pbox .name{
    font-weight:700;
    color:var(--gold);
  }
  .pbox .time{
    margin-top:4px;
    font-size:20px;
    color:var(--blue-1);
  }

  .countdown{
    margin-top:8px;
    font-size:14px;
    color:var(--gold-soft);
    font-weight:600;
  }

  /* KOLOM TABEL */
  .two-cols{
    display:flex;
    gap:20px;
    margin-top:10px;
  }
  .col-1, .col-2{
    border-radius:14px;
    padding:20px;

    background:linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.05));
    border:1px solid rgba(255,255,255,0.08);
    box-shadow:0 5px 15px rgba(0,0,0,0.4);
  }
  .col-1 {flex: 70%}
  .col-2 {flex: 30%}
  .col-1  h3,
  .col-2  h3{
    margin:0 0 10px;
    font-size:19px;
    font-weight:800;
    color:var(--gold);
  }

  /* TABEL */
  table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
    color:var(--muted);
  }
  thead th{
    padding:10px;
    background:linear-gradient(90deg, rgba(77,163,255,0.15), rgba(20,50,90,0.12));
    border-bottom:2px solid rgba(77,163,255,0.35);
    color:var(--gold);
    font-weight:700;
  }
  tbody td{
    padding:10px;
    border-bottom:1px dashed rgba(255,255,255,0.1);
  }

  /* PENGUMUMAN */
  .ann{
    margin-top:10px;
    padding:14px 16px;
    border-radius:12px;

    background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
    border:1px solid rgba(255,255,255,0.1);
    color:var(--muted);
  }

  /* Running Text */
  .runwrap{
    margin-top:10px;
    padding:12px;
    border-radius:10px;

    border:1px solid rgba(255,255,255,0.07);
    background:linear-gradient(90deg, rgba(77,163,255,0.15), rgba(255,255,255,0.04));
    overflow:hidden;
  }
  .runtext{
    white-space:nowrap;
    display:inline-block;
    padding-left:100%;
    font-weight:700;
    animation:run 18s linear infinite;
    color:var(--gold);
  }
  @keyframes run{from{transform:translateX(0)} to{transform:translateX(-100%)}}

  /* Responsive */
  @media(max-width:1100px){
    .two-cols{flex-direction:column}
    .top-row{flex-direction:column}
    .clock-card{width:100%}
  }

  /* Lebar kolom tanggal */
  #laporanTable td:first-child,
  #laporanTable th:first-child{
    width:180px !important;
    white-space:nowrap;
  }
</style>
</head>
<body>
  <div class="wrap">
    <main class="card-main">

      <!-- HEADER -->
      <header class="header">
        <div class="brand">
          <div class="logo"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSK__Zzu3WA3vHb2EYPCQKIG896FSCJO9_3stRFhbZ_6mG0ASSt2aHeDL6l59dDgjZyE6s&usqp=CAU" width="80"  height="60" alt="logo"></div>
          <div>

            <h1 style="margin-top: 8px;">Portal Masjid Al-Barkah</h1>
            <p class="small">Informasi jadwal sholat, keuangan, dan pengumuman</p>
          </div>
        </div>

        <div class="text-end">
          <div style="font-size:14px;color:var(--muted)">Lokasi</div>
          <div style="font-weight:700;color:var(--green-1);font-size:16px" id="locationLabel">—</div>
        </div>
      </header>

      <!-- JADWAL SHOLAT -->
      <section class="top-row">
        <div class="pray">
          <div class="left">
            <h2>Waktu Sholat (Realtime)</h2>
            <div class="small" id="dateLabel">—</div>
          </div>

          <div style="flex:1">
            <div class="times" id="prayerBoxes"></div>
            <div class="countdown" id="nextInfo"></div>
          </div>
        </div>

        <div class="clock-card">
          <div style="font-size:12px;color:var(--muted)">Jam Sekarang</div>
          <div class="clock-now" id="clockNow">--:--:--</div>
          <div class="hijri-now" id="hijriNow">—</div>
        </div>
      </section>

      <!-- TABEL -->
      <section class="two-cols">
        <div class="col-1">
          <h3>Laporan Keuangan</h3>
          <div class="table-responsive">
            <table id="laporanTable">
              <thead>
                <tr><th>Tanggal</th><th>Saldo Awal</th><th>Kotak Amal Jumat</th><th>Pengeluaran</th><th>Saldo Terakhir</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="col-2">
          <h3>Khotib Jumat</h3>
          <div class="table-responsive">
            <table id="khotibTable">
              <thead><tr><th>Tanggal</th><th>Khotib</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <div class="runwrap">
        <div class="runtext" id="runText">KAMI SEGENAP PEGAWAI PT SSI TURUT BERDUKA ATAS BENCANA SUMATERA , KITA BERDOA AGAR TEMAN-TEMAN DI SANA SELAMAT DALAM LINDUNGAN TUHAN YME </div>
      </div>
      <br>
      <br>  
      <!-- PENGUMUMAN -->
      <div class="ann">
        <strong>Pengumuman :</strong>
        <div id="pengumumanList" style="margin-top:10px"></div>
      </div>

      

    </main>
  </div>

  <script>
  const GAS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxUtury5NX15DIQnkZLsvfqFO6veFU22rRfhmrkoDGaVv6Zuij7gGTV8GfAQJd_pFnh/exec';
  const CITY = 'Bekasi';
  const COUNTRY = 'Indonesia';
  const ALADHAN_BYCITY = true;

  function $q(sel){ return document.querySelector(sel); }

  // More robust escapeHtml (avoid arrow/object ambiguity)
  function escapeHtml(s){
    return String(s || '').replace(/[&<>"]/g, function(c){
      return { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;' }[c];
    });
  }

  function formatTanggalOnly(tgl){
    if(!tgl) return '';
    try {
      const d = new Date(tgl);
      if(isNaN(d)) return tgl;
      return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
    } catch(e){ return tgl; }
  }

  function startClock(){
    const clock = $q('#clockNow');
    function tick(){
      clock.textContent = new Date().toLocaleTimeString();
    }
    tick(); setInterval(tick,1000);
  }

  async function fetchSheet(sheet){
    try{
      const res = await fetch(`${GAS_WEBAPP_URL}?sheet=${encodeURIComponent(sheet)}`);
      const json = await res.json();
      return json.rows || [];
    }catch(e){ console.warn('fetchSheet error', e); return []; }
  }

  // Format angka ke Rupiah
  function formatRupiah(angka){
    if(angka === null || angka === undefined || angka === '') return "Rp 0";
    // Remove non-digit except minus and dot, handle parentheses etc.
    const s = String(angka).replace(/[^\d\-\.]/g, '');
    const isNegative = s.startsWith('-');
    const cleaned = s.replace('-', '');
    // If there is decimal, we will ignore decimals for currency whole rupiah
    const intPart = parseInt(cleaned.split('.')[0] || '0', 10);
    if(isNaN(intPart)) return "Rp 0";
    return (isNegative ? '- ' : '') + 'Rp ' + intPart.toLocaleString('id-ID');
  }

  async function loadAllData(){
    /* Laporan */
    const lap = await fetchSheet('Laporan');
    const lapTbody = $q('#laporanTable tbody');
    lapTbody.innerHTML = '';

    if(!lap || lap.length === 0){
      lapTbody.innerHTML = '<tr><td colspan="5">Belum ada data</td></tr>';
    } else {
      // tampilkan maksimal 10 baris terbaru (asumsi sudah berurutan di sheet)
      lap.slice(0,10).forEach(r=>{
        const tr = document.createElement('tr');

        ['Tanggal','Saldo Awal','Kotak Amal Jumat','Pengeluaran','Saldo Terakhir'].forEach(k=>{
          const td = document.createElement('td');
          if(k === 'Tanggal'){
            td.textContent = formatTanggalOnly(r[k]);
          } else {
            td.textContent = formatRupiah(r[k]);
          }
          tr.appendChild(td);
        });

        lapTbody.appendChild(tr);
      });
    }

    /* Khotib */
    const kh = await fetchSheet('Khotib');
    const khTbody = $q('#khotibTable tbody');
    khTbody.innerHTML = '';

    if(!kh || kh.length===0){
      khTbody.innerHTML = '<tr><td colspan="2">Belum ada data</td></tr>';
    } else {
      kh.slice(0,10).forEach(r=>{
        const tr = document.createElement('tr');
        const td1 = document.createElement('td');
        td1.textContent = formatTanggalOnly(r['Tanggal']);
        const td2 = document.createElement('td');
        td2.textContent = escapeHtml(r['Khotib']);
        tr.appendChild(td1);
        tr.appendChild(td2);
        khTbody.appendChild(tr);
      });
    }

    /* Pengumuman */
    const p = await fetchSheet('Pengumuman');
    const pWrap = $q('#pengumumanList');
    pWrap.innerHTML = '';

    if(!p || p.length===0){
      pWrap.innerHTML = '<div>Belum ada pengumuman</div>';
    } else {
      p.forEach(r=>{
        const d = document.createElement('div');
        d.textContent = r['Pengumuman'] || '';
        pWrap.appendChild(d);
      });
      $q('#runText').textContent = p.map(x=>x['Pengumuman']).filter(Boolean).join(' • ');
    }
  }

  /* AlAdhan */
  let currentTimings = null;

  async function fetchPrayerTimes(){
    try{
      const url = ALADHAN_BYCITY
        ? `https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(CITY)}&country=${encodeURIComponent(COUNTRY)}&method=11`
        : `https://api.aladhan.com/v1/timings?latitude=-6.2&longitude=106.816666&method=11`;

      const res = await fetch(url);
      const data = await res.json();
      if(data && data.data){
        currentTimings = data.data;
        renderPrayerTimes(data.data);
      } else {
        console.warn('AlAdhan returned unexpected data', data);
      }
    }catch(e){ console.warn('fetchPrayerTimes error', e); }
  }

  function renderPrayerTimes(data){
    const boxes = $q('#prayerBoxes');
    boxes.innerHTML = '';

    const times = {
      Fajr: data.timings.Fajr,
      Dhuhr: data.timings.Dhuhr,
      Asr: data.timings.Asr,
      Maghrib: data.timings.Maghrib,
      Isha: data.timings.Isha
    };

    $q('#locationLabel').textContent = `${CITY}, ${COUNTRY}`;
    if(data.date && data.date.readable){
      $q('#dateLabel').textContent = `${data.date.readable} — Hijri: ${data.date.hijri.date} ${data.date.hijri.month.en}`;
    }

    Object.entries(times).forEach(([name,t])=>{
      const div = document.createElement('div');
      div.className = 'pbox';
      div.innerHTML = `<div class="name">${escapeHtml(name)}</div><div class="time">${escapeHtml(t)}</div>`;
      boxes.appendChild(div);
    });

    updateNextCountdown();
  }

  function updateNextCountdown(){
    if(!currentTimings) return;

    const now = new Date();
    const today = new Date();
    const keys = ['Fajr','Dhuhr','Asr','Maghrib','Isha'];

    const parts = keys.map(k=>{
      const match = (currentTimings.timings[k] || '').match(/\d{1,2}:\d{2}/);
      if(!match) return null;
      const [hh,mm] = match[0].split(':').map(Number);
      return {name:k, date:new Date(today.getFullYear(), today.getMonth(), today.getDate(), hh, mm)};
    }).filter(Boolean);

    let next = parts.find(p=>p.date > now);
    if(!next && parts.length){
      const fajr = parts.find(p=>p.name==='Fajr') || parts[0];
      next = {name:'Fajr', date:new Date(fajr.date.getTime()+86400000)};
    }

    function tick(){
      const now2 = new Date();
      const diff = next.date - now2;
      if(diff<=0){ fetchPrayerTimes(); return; }

      const hrs = Math.floor(diff/36e5);
      const mins = Math.floor((diff%36e5)/6e4);
      const secs = Math.floor((diff%6e4)/1000);

      $q('#nextInfo').textContent = `Berikutnya: ${next.name} dalam ${hrs}j ${mins}m ${secs}s`;
    }

    tick();
    clearInterval(window._nextTick);
    window._nextTick = setInterval(tick,1000);
  }

  async function init(){
    startClock();
    await loadAllData();
    setInterval(loadAllData,60000);

    await fetchPrayerTimes();
    setInterval(fetchPrayerTimes,300000);

    /* kecilkan efek muncul running text */
    setInterval(()=>{
      const el = $q('#runText');
      if(el) el.style.opacity = '1';
    },5000);
  }

  init();

    setTimeout(() => {
  window.location.href = "berita.html";
  }, 300000); // 5 menit
    
  </script>

</body>
</html>
